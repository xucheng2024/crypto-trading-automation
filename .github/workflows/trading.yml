name: Crypto Trading Automation

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      scripts:
        description: 'Comma-separated scripts to run (e.g., cancel_pending_triggers,create_algo_triggers)'
        required: false
        default: 'monitor_delist,cancel_pending_limits,fetch_filled_orders,auto_sell_orders'

  # Cloudflare Worker 触发
  repository_dispatch:
    types: [cron]

# 动态设置运行名称
run-name: |
  ${{ github.event_name == 'workflow_dispatch' && format('Manual: {0}', github.event.inputs.scripts) || format('Auto: {0}', join(github.event.client_payload.scripts, ', ')) }}

jobs:
  trading:
    name: Crypto Trading Bot
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Log execution time and scripts
        run: |
          echo "🕐 Workflow started at: $(date -u)"
          echo "🕐 UTC time: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)"
          echo "🕐 Event type: ${{ github.event_name }}"
          echo "=========================================="
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "🎯 MANUAL TRIGGER - Scripts: ${{ github.event.inputs.scripts }}"
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "🤖 AUTO TRIGGER - Scripts: ${{ join(github.event.client_payload.scripts, ', ') }}"
            echo "📅 Cron schedule: ${{ github.event.client_payload.cron_schedule }}"
            echo "⏰ Interval: ${{ github.event.client_payload.interval }}"
          fi
          echo "=========================================="
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      # 第一层：缓存 uv 包管理器
      - name: Cache uv binary
        uses: actions/cache@v4
        with:
          path: ~/.local/bin/uv
          key: uv-binary-${{ runner.os }}-py311
          restore-keys: |
            uv-binary-${{ runner.os }}-

      # 第二层：缓存 uv 下载的包
      - name: Cache uv packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-packages-${{ runner.os }}-py311-${{ hashFiles('uv.lock', 'pyproject.toml', 'requirements.txt') }}
          restore-keys: |
            uv-packages-${{ runner.os }}-py311-
            uv-packages-${{ runner.os }}-

      # 第三层：缓存 Python 虚拟环境
      - name: Cache Python venv
        uses: actions/cache@v4
        with:
          path: .venv
          key: python-venv-${{ runner.os }}-py311-${{ hashFiles('uv.lock', 'pyproject.toml', 'requirements.txt') }}
          restore-keys: |
            python-venv-${{ runner.os }}-py311-
            python-venv-${{ runner.os }}-

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: |
          mkdir -p logs
          set -o pipefail
          ~/.local/bin/uv sync --locked 2>&1 | tee logs/uv_install.log
      
      - name: Initialize executed scripts list
        run: |
          : > logs/executed_scripts.txt
          
      - name: Activate virtual environment
        run: |
          source .venv/bin/activate
          echo "✅ Virtual environment activated"
          
      - name: 🔍 Execute monitor_delist.py - Delisting Protection
        if: (github.event_name == 'workflow_dispatch' && contains(github.event.inputs.scripts, 'monitor_delist')) || (github.event_name == 'repository_dispatch' && github.event.action == 'cron' && contains(toJSON(github.event.client_payload.scripts), 'monitor_delist'))
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OKX_API_KEY: ${{ secrets.OKX_API_KEY }}
          OKX_SECRET_KEY: ${{ secrets.OKX_SECRET_KEY }}
          OKX_PASSPHRASE: ${{ secrets.OKX_PASSPHRASE }}
        run: |
          echo "🔄 Running monitor_delist.py..."
          echo "monitor_delist" >> logs/executed_scripts.txt
          source .venv/bin/activate && python monitor_delist.py || echo "⚠️ monitor_delist.py completed with warnings"
          
      - name: 💰 Execute auto_sell_orders.py - Market Sell Orders
        if: (github.event_name == 'workflow_dispatch' && contains(github.event.inputs.scripts, 'auto_sell_orders')) || (github.event_name == 'repository_dispatch' && github.event.action == 'cron' && contains(github.event.client_payload.scripts, 'auto_sell_orders'))
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OKX_API_KEY: ${{ secrets.OKX_API_KEY }}
          OKX_SECRET_KEY: ${{ secrets.OKX_SECRET_KEY }}
          OKX_PASSPHRASE: ${{ secrets.OKX_PASSPHRASE }}
        run: |
          echo "🔄 Running auto_sell_orders.py..."
          echo "auto_sell_orders" >> logs/executed_scripts.txt
          source .venv/bin/activate && python auto_sell_orders.py || echo "⚠️ auto_sell_orders.py completed with warnings"
          
      - name: 📊 Execute fetch_filled_orders.py - Order Tracking
        if: (github.event_name == 'workflow_dispatch' && contains(github.event.inputs.scripts, 'fetch_filled_orders')) || (github.event_name == 'repository_dispatch' && github.event.action == 'cron' && contains(github.event.client_payload.scripts, 'fetch_filled_orders'))
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OKX_API_KEY: ${{ secrets.OKX_API_KEY }}
          OKX_SECRET_KEY: ${{ secrets.OKX_SECRET_KEY }}
          OKX_PASSPHRASE: ${{ secrets.OKX_PASSPHRASE }}
        run: |
          echo "🔄 Running fetch_filled_orders.py..."
          echo "fetch_filled_orders" >> logs/executed_scripts.txt
          source .venv/bin/activate && python fetch_filled_orders.py || echo "⚠️ fetch_filled_orders.py completed with warnings"
          
      - name: ❌ Execute cancel_pending_limits.py - Limit Order Management
        if: (github.event_name == 'workflow_dispatch' && contains(github.event.inputs.scripts, 'cancel_pending_limits')) || (github.event_name == 'repository_dispatch' && github.event.action == 'cron' && contains(toJSON(github.event.client_payload.scripts), 'cancel_pending_limits'))
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OKX_API_KEY: ${{ secrets.OKX_API_KEY }}
          OKX_SECRET_KEY: ${{ secrets.OKX_SECRET_KEY }}
          OKX_PASSPHRASE: ${{ secrets.OKX_PASSPHRASE }}
        run: |
          echo "🔄 Running cancel_pending_limits.py..."
          echo "cancel_pending_limits" >> logs/executed_scripts.txt
          source .venv/bin/activate && python cancel_pending_limits.py --side buy || echo "⚠️ cancel_pending_limits.py completed with warnings"
          
      - name: 🌙 Execute cancel_pending_triggers.py - Nightly Cleanup
        if: (
              github.event_name == 'workflow_dispatch' && (
                contains(github.event.inputs.scripts, 'cancel_pending_triggers') ||
                contains(github.event.inputs.scripts, 'cancel_triggers') ||
                contains(github.event.inputs.scripts, 'cancel_trigger') ||
                contains(github.event.inputs.scripts, 'cancel') ||
                contains(github.event.inputs.scripts, 'nightly')
              )
            ) || (
              github.event_name == 'repository_dispatch' && github.event.action == 'cron' && contains(toJSON(github.event.client_payload.scripts), 'cancel_pending_triggers')
            )
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OKX_API_KEY: ${{ secrets.OKX_API_KEY }}
          OKX_SECRET_KEY: ${{ secrets.OKX_SECRET_KEY }}
          OKX_PASSPHRASE: ${{ secrets.OKX_PASSPHRASE }}
        run: |
          echo "🔄 Running cancel_pending_triggers.py..."
          echo "cancel_pending_triggers" >> logs/executed_scripts.txt
          source .venv/bin/activate && python cancel_pending_triggers.py || echo "⚠️ cancel_pending_triggers.py completed with warnings"
          
      - name: 🌅 Execute create_algo_triggers.py - Morning Setup
        if: (
              github.event_name == 'workflow_dispatch' && (
                contains(github.event.inputs.scripts, 'create_algo_triggers') ||
                contains(github.event.inputs.scripts, 'create_triggers') ||
                contains(github.event.inputs.scripts, 'create_trigger') ||
                contains(github.event.inputs.scripts, 'create') ||
                contains(github.event.inputs.scripts, 'nightly')
              )
            ) || (
              github.event_name == 'repository_dispatch' && github.event.action == 'cron' && contains(toJSON(github.event.client_payload.scripts), 'create_algo_triggers')
            )
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OKX_API_KEY: ${{ secrets.OKX_API_KEY }}
          OKX_SECRET_KEY: ${{ secrets.OKX_SECRET_KEY }}
          OKX_PASSPHRASE: ${{ secrets.OKX_PASSPHRASE }}
          OKX_ORDER_SIZE: ${{ secrets.OKX_ORDER_SIZE }}
        run: |
          echo "🔄 Running create_algo_triggers.py..."
          echo "create_algo_triggers" >> logs/executed_scripts.txt
          source .venv/bin/activate && python create_algo_triggers.py || echo "⚠️ create_algo_triggers.py completed with warnings"

      - name: Write run summary
        if: always()
        run: |
          echo "### Executed scripts" >> "$GITHUB_STEP_SUMMARY"
          if [ -s logs/executed_scripts.txt ]; then
            sort -u logs/executed_scripts.txt | sed 's/^/- /' | tee -a "$GITHUB_STEP_SUMMARY"
          else
            echo "- None" | tee -a "$GITHUB_STEP_SUMMARY"
          fi
          
      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trading-logs-${{ github.run_id }}
          path: |
            logs/**
            *.log
          if-no-files-found: ignore
          retention-days: 7
