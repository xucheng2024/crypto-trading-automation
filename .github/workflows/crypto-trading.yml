name: Crypto Trading Daily Automation

on:
  schedule:
    # 每天早上 0:03 执行买入策略（设置 trigger 订单）
    - cron: '3 0 * * *'
    # 每天晚上 23:57 取消未成交的 trigger 订单
    - cron: '57 23 * * *'
    # 每5分钟执行卖出策略
    - cron: '*/5 * * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  trading-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: Determine Action Type
      id: action-type
      run: |
        # 根据当前时间确定要执行的操作
        current_hour=$(date -u +%H)
        current_minute=$(date -u +%M)
        
        if [ "$current_hour" = "00" ] && [ "$current_minute" = "03" ]; then
          echo "action=buy" >> $GITHUB_OUTPUT
          echo "🟢 Executing BUY strategy (setting trigger orders)"
        elif [ "$current_hour" = "23" ] && [ "$current_minute" = "57" ]; then
          echo "action=cancel" >> $GITHUB_OUTPUT
          echo "🔴 Executing CANCEL strategy (canceling unfilled trigger orders)"
        else
          echo "action=sell" >> $GITHUB_OUTPUT
          echo "🟡 Executing SELL strategy (checking and selling if needed)"
        fi
    
    - name: Execute Buy Strategy
      if: steps.action-type.outputs.action == 'buy'
      run: |
        echo "🚀 Executing BUY strategy at $(date)"
        echo "📊 Setting trigger orders for cryptocurrencies..."
        
        response=$(curl -s -X POST ${{ secrets.VERCEL_API_ENDPOINT }}/api/algo-buy \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.STRATEGY_API_KEY }}" \
          -w "\n%{http_code}")
        
        http_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "📡 Buy API Response: $http_code"
        echo "📄 Response: $response_body"
        
        if [ "$http_code" = "200" ]; then
          echo "✅ Buy strategy executed successfully!"
        else
          echo "❌ Buy strategy failed: $http_code"
          exit 1
        fi
    
    - name: Execute Cancel Strategy
      if: steps.action-type.outputs.action == 'cancel'
      run: |
        echo "🚀 Executing CANCEL strategy at $(date)"
        echo "📊 Canceling unfilled trigger orders..."
        
        response=$(curl -s -X POST ${{ secrets.VERCEL_API_ENDPOINT }}/api/cancel-orders \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.STRATEGY_API_KEY }}" \
          -w "\n%{http_code}")
        
        http_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "📡 Cancel API Response: $http_code"
        echo "📄 Response: $response_body"
        
        if [ "$http_code" = "200" ]; then
          echo "✅ Cancel strategy executed successfully!"
        else
          echo "❌ Cancel strategy failed: $http_code"
          exit 1
        fi
    
    - name: Execute Sell Strategy
      if: steps.action-type.outputs.action == 'sell'
      run: |
        echo "🚀 Executing SELL strategy at $(date)"
        echo "📊 Checking if selling is needed..."
        
        response=$(curl -s -X POST ${{ secrets.VERCEL_API_ENDPOINT }}/api/market-sell \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.STRATEGY_API_KEY }}" \
          -w "\n%{http_code}")
        
        http_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "📡 Sell API Response: $http_code"
        echo "📄 Response: $response_body"
        
        if [ "$http_code" = "200" ]; then
          echo "✅ Sell strategy executed successfully!"
        else
          echo "❌ Sell strategy failed: $http_code"
          exit 1
        fi
    
    - name: Log Completion
      run: |
        echo "🎯 Trading automation completed at $(date)"
        echo "📊 Action executed: ${{ steps.action-type.outputs.action }}"
