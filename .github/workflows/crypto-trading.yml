name: Crypto Trading Daily Automation

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 0:03 æ‰§è¡Œä¹°å…¥ç­–ç•¥ï¼ˆè®¾ç½® trigger è®¢å•ï¼‰
    - cron: '3 0 * * *'
    # æ¯å¤©æ™šä¸Š 23:57 å–æ¶ˆæœªæˆäº¤çš„ trigger è®¢å•
    - cron: '57 23 * * *'
    # æ¯5åˆ†é’Ÿæ‰§è¡Œå–å‡ºç­–ç•¥
    - cron: '*/5 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  trading-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: Determine Action Type
      id: action-type
      run: |
        # æ ¹æ®å½“å‰æ—¶é—´ç¡®å®šè¦æ‰§è¡Œçš„æ“ä½œ
        current_hour=$(date -u +%H)
        current_minute=$(date -u +%M)
        
        if [ "$current_hour" = "00" ] && [ "$current_minute" = "03" ]; then
          echo "action=buy" >> $GITHUB_OUTPUT
          echo "ğŸŸ¢ Executing BUY strategy (setting trigger orders)"
        elif [ "$current_hour" = "23" ] && [ "$current_minute" = "57" ]; then
          echo "action=cancel" >> $GITHUB_OUTPUT
          echo "ğŸ”´ Executing CANCEL strategy (canceling unfilled trigger orders)"
        else
          echo "action=sell" >> $GITHUB_OUTPUT
          echo "ğŸŸ¡ Executing SELL strategy (checking and selling if needed)"
        fi
    
    - name: Execute Buy Strategy
      if: steps.action-type.outputs.action == 'buy'
      run: |
        echo "ğŸš€ Executing BUY strategy at $(date)"
        echo "ğŸ“Š Setting trigger orders for cryptocurrencies..."
        
        response=$(curl -s -X POST ${{ secrets.VERCEL_API_ENDPOINT }}/api/algo-buy \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.STRATEGY_API_KEY }}" \
          -w "\n%{http_code}")
        
        http_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "ğŸ“¡ Buy API Response: $http_code"
        echo "ğŸ“„ Response: $response_body"
        
        if [ "$http_code" = "200" ]; then
          echo "âœ… Buy strategy executed successfully!"
        else
          echo "âŒ Buy strategy failed: $http_code"
          exit 1
        fi
    
    - name: Execute Cancel Strategy
      if: steps.action-type.outputs.action == 'cancel'
      run: |
        echo "ğŸš€ Executing CANCEL strategy at $(date)"
        echo "ğŸ“Š Canceling unfilled trigger orders..."
        
        response=$(curl -s -X POST ${{ secrets.VERCEL_API_ENDPOINT }}/api/cancel-orders \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.STRATEGY_API_KEY }}" \
          -w "\n%{http_code}")
        
        http_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "ğŸ“¡ Cancel API Response: $http_code"
        echo "ğŸ“„ Response: $response_body"
        
        if [ "$http_code" = "200" ]; then
          echo "âœ… Cancel strategy executed successfully!"
        else
          echo "âŒ Cancel strategy failed: $http_code"
          exit 1
        fi
    
    - name: Execute Sell Strategy
      if: steps.action-type.outputs.action == 'sell'
      run: |
        echo "ğŸš€ Executing SELL strategy at $(date)"
        echo "ğŸ“Š Checking if selling is needed..."
        
        response=$(curl -s -X POST ${{ secrets.VERCEL_API_ENDPOINT }}/api/market-sell \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.STRATEGY_API_KEY }}" \
          -w "\n%{http_code}")
        
        http_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "ğŸ“¡ Sell API Response: $http_code"
        echo "ğŸ“„ Response: $response_body"
        
        if [ "$http_code" = "200" ]; then
          echo "âœ… Sell strategy executed successfully!"
        else
          echo "âŒ Sell strategy failed: $http_code"
          exit 1
        fi
    
    - name: Log Completion
      run: |
        echo "ğŸ¯ Trading automation completed at $(date)"
        echo "ğŸ“Š Action executed: ${{ steps.action-type.outputs.action }}"
