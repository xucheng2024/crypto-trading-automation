name: Crypto Trading Automation

on:
  schedule:
    # Run every 15 minutes during market hours (UTC)
    - cron: '*/15 13-23 * * 1-5'  # Monday-Friday 1PM-11PM UTC
    - cron: '*/15 0-11 * * 1-5'   # Monday-Friday 12AM-11AM UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  trading-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Test OKX Connection
      env:
        OKX_API_KEY: ${{ secrets.OKX_API_KEY }}
        OKX_SECRET_KEY: ${{ secrets.OKX_SECRET_KEY }}
        OKX_PASSPHRASE: ${{ secrets.OKX_PASSPHRASE }}
        OKX_TESTNET: ${{ secrets.OKX_TESTNET }}
      run: |
        echo "Testing OKX API connection..."
        # This would test the connection before proceeding
        
    - name: Execute Algorithmic Trading
      env:
        OKX_API_KEY: ${{ secrets.OKX_API_KEY }}
        OKX_SECRET_KEY: ${{ secrets.OKX_SECRET_KEY }}
        OKX_PASSPHRASE: ${{ secrets.OKX_PASSPHRASE }}
        OKX_TESTNET: ${{ secrets.OKX_TESTNET }}
        STRATEGY_API_KEY: ${{ secrets.STRATEGY_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        echo "üöÄ Executing Algorithmic Trading Strategy at $(date)"
        echo "üìä Will place trigger orders for ALL cryptocurrencies in config"
        echo "üí∞ Each order uses FULL available balance"
        
        # Execute the algorithmic trading strategy
        response=$(curl -s -X POST ${{ secrets.API_ENDPOINT }}/api/algo-trading \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.STRATEGY_API_KEY }}" \
          -w "\n%{http_code}")
        
        # Extract response body and status code
        http_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "üì° API Response Status: $http_code"
        echo "üìÑ Response Body: $response_body"
        
        if [ "$http_code" = "200" ]; then
          echo "‚úÖ Algorithmic trading executed successfully!"
          
          # Parse and display results
          total_orders=$(echo "$response_body" | jq -r '.summary.totalOrders // "N/A"')
          successful_orders=$(echo "$response_body" | jq -r '.summary.successfulOrders // "N/A"')
          failed_orders=$(echo "$response_body" | jq -r '.summary.failedOrders // "N/A"')
          total_value=$(echo "$response_body" | jq -r '.summary.totalValue // "N/A"')
          
          echo "üìä Execution Summary:"
          echo "   Total Orders: $total_orders"
          echo "   Successful: $successful_orders"
          echo "   Failed: $failed_orders"
          echo "   Total Value: $total_value"
          
        else
          echo "‚ùå Algorithmic trading failed with status: $http_code"
          echo "Error details: $response_body"
          exit 1
        fi
        
        echo "üéØ Algorithmic trading execution completed"
        
    - name: Log results
      run: |
        echo "üéØ Algorithmic trading job completed at $(date)"
        echo "üìä Check OKX account for trigger orders placed"
        echo "üí∞ Orders will execute when prices reach trigger levels"
        echo "üìà Monitor market conditions for order execution"
